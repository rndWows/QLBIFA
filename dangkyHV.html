<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký Thành Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <!-- Choices.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <style>
        body {
            background: linear-gradient(to bottom, #f0fdfa, #ccfbf1);
            scroll-behavior: smooth;
        }

        .header-bg {
            background: linear-gradient(to right, #34d399, #10b981);
            clip-path: ellipse(150% 100% at center top);
        }

        .logo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 128, 0, 0.2);
        }

        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 128, 0, 0.2);
        }

        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gradient-border {
            border-image: linear-gradient(to right, #34d399, #10b981) 1;
        }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loadingOverlay .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Image preview */
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Custom styles for Choices.js */
        .choices__inner {
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            min-height: 44px;
            padding: 0.5rem;
        }

        .choices__list--multiple .choices__item {
            background-color: #10b981;
            border: 1px solid #10b981;
            border-radius: 0.25rem;
            color: white;
        }

        .choices__list--multiple .choices__item.is-highlighted {
            background-color: #059669;
            border: 1px solid #059669;
        }

        .choices__input {
            background-color: transparent;
        }
    </style>
</head>

<body class="font-sans antialiased">
    <!-- Header Section -->
    <div class="header-bg py-8">
        <div class="container mx-auto px-4 text-center fade-in">
            <img src="https://scontent.fsgn21-1.fna.fbcdn.net/v/t39.30808-6/453011757_887649283405866_8248667612509737856_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=owhXK9hlQWAQ7kNvwEz9cyb&_nc_oc=AdlIOJFbc3vOsfcSdBt02v09XV9yyEslwOnjn21VexBkGJI-ByzHuYn2mnAqUImzsOc&_nc_zt=23&_nc_ht=scontent.fsgn21-1.fna&_nc_gid=G9LyWD_bhSwr-R2qfk6Crg&oh=00_AfHCipo3VomwpY1LvFiZotbW6iWqU9oOovhrvg7aUJUvVA&oe=67FA6962"
                alt="Wood Association Logo" class="logo mx-auto mb-4">
            <h1 class="text-4xl font-extrabold text-white">Đăng Ký Thành Viên</h1>
            <p class="text-lg text-white mt-4">Tham gia hiệp hội gỗ danh giá của chúng tôi ngay hôm nay!</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 fade-in">
        <div
            class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden hover-card transition-transform duration-300">
            <!-- Form -->
            <form id="memberForm" class="p-6 md:p-8 space-y-8">
                <!-- Thông Tin Cá Nhân -->
                <div>
                    <h3 class="text-xl md:text-2xl font-semibold text-green-700 mb-6">Thông Tin Cá Nhân</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="fullname" class="block text-sm font-medium text-gray-700">Họ và Tên(*)</label>
                            <input type="text" id="fullname" name="fullname"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập họ và tên" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Số Điện Thoại(*)</label>
                            <input type="tel" id="phone" name="phone"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập số điện thoại" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giới Tính</label>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="male" name="gender" value="Nam" checked
                                        class="h-4 w-4 text-green-600 focus:ring-green-500">
                                    <label for="male" class="ml-2 text-sm text-gray-700">Nam</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="female" name="gender" value="Nữ"
                                        class="h-4 w-4 text-green-600 focus:ring-green-500">
                                    <label for="female" class="ml-2 text-sm text-gray-700">Nữ</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="other" name="gender" value="Khác"
                                        class="h-4 w-4 text-green-600 focus:ring-green-500">
                                    <label for="other" class="ml-2 text-sm text-gray-700">Khác</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email(*)</label>
                            <input type="email" id="email" name="email"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập email" required>
                        </div>
                        <div>
                            <label for="image" class="block text-sm font-medium text-gray-700">Hình Ảnh(*)</label>
                            <input type="file" id="image" name="image" accept="image/*"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500">
                            <div id="imagePreview" class="mt-2"></div>
                        </div>

                        <div>
                            <label for="birthday" class="block text-sm font-medium text-gray-700">Ngày Sinh</label>
                            <input type="date" id="birthday" name="birthday"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="hometown" class="block text-sm font-medium text-gray-700">Nguyên Quán</label>
                            <input type="text" id="hometown" name="hometown"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập nguyên quán">
                        </div>
                        <!-- New fields for personal information -->
                        <div>
                            <label for="ethnicity" class="block text-sm font-medium text-gray-700">Dân Tộc</label>
                            <input type="text" id="ethnicity" name="ethnicity"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập dân tộc">
                        </div>
                        <div>
                            <label for="religion" class="block text-sm font-medium text-gray-700">Tôn Giáo</label>
                            <input type="text" id="religion" name="religion"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập tôn giáo">
                        </div>
                        <div>
                            <label for="education" class="block text-sm font-medium text-gray-700">Trình Độ</label>
                            <select id="education" name="education"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500">
                                <option value="" selected disabled>Chọn trình độ học vấn</option>
                                <option value="Trung cấp">Trung cấp</option>
                                <option value="Cao đẳng">Cao đẳng</option>
                                <option value="Đại học">Đại học</option>
                                <option value="Sau đại học">Sau đại học</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                        <div>
                            <label for="referrer" class="block text-sm font-medium text-gray-700">Người Giới
                                Thiệu</label>
                            <input type="text" id="referrer" name="referrer"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập tên người giới thiệu">
                        </div>
                    </div>
                </div>

                <!-- Thông Tin Công Ty -->
                <div>
                    <h3 class="text-xl md:text-2xl font-semibold text-green-700 mb-6">Thông Tin Công Ty</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-1 sm:col-span-2">
                            <label for="company_name" class="block text-sm font-medium text-gray-700">Tên Công
                                Ty(*)</label>
                            <input type="text" id="company_name" name="company_name" required
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập tên công ty">
                        </div>
                        <div>
                            <label for="shortname" class="block text-sm font-medium text-gray-700">Tên Viết Tắt Công
                                Ty</label>
                            <input type="text" id="shortname" name="shortname"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập tên viết tắt">
                        </div>

                        <div class="col-span-1 sm:col-span-2">
                            <label for="company_address" class="block text-sm font-medium text-gray-700">Địa Chỉ Công
                                Ty(*)</label>
                            <input type="text" id="company_address" name="company_address" required
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập địa chỉ công ty">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700">Chức Vụ</label>
                            <input type="text" id="position" name="position"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập chức vụ">
                        </div>

                        <!-- New fields for company information -->
                        <div>
                            <label for="company_founding_date" class="block text-sm font-medium text-gray-700">Ngày
                                Thành Lập CTY</label>
                            <input type="date" id="company_founding_date" name="company_founding_date"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500">
                        </div>

                        <!-- Nhóm Ngành Nghề - Choices.js -->
                        <div class="col-span-1 sm:col-span-2">
                            <label for="industry_group" class="block text-sm font-medium text-gray-700 mb-2">Nhóm Ngành
                                Nghề</label>
                            <select id="industry_group" name="industry_group" multiple class="mt-2">
                                <!-- Options sẽ được thêm vào bằng JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label for="company_logo" class="block text-sm font-medium text-gray-700">Logo Công
                                Ty</label>
                            <input type="file" id="company_logo" name="company_logo" accept="image/*"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500">
                            <div id="logoPreview" class="mt-2"></div>
                        </div>

                        <!-- Ngành Nghề KD - Choices.js -->
                        <div class="col-span-1 sm:col-span-2">
                            <label for="business_field" class="block text-sm font-medium text-gray-700 mb-2">Ngành Nghề
                                KD</label>
                            <select id="business_field" name="business_field" multiple class="mt-2">
                                <!-- Options sẽ được thêm vào bằng JavaScript -->
                            </select>
                        </div>

                        <div class="col-span-1 sm:col-span-2">
                            <label for="company_intro" class="block text-sm font-medium text-gray-700">Giới Thiệu Công
                                Ty</label>
                            <textarea id="company_intro" name="company_intro" rows="2"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập giới thiệu về công ty"></textarea>
                        </div>
                        <div>
                            <label for="tax_code" class="block text-sm font-medium text-gray-700">Mã Số Thuế</label>
                            <input type="text" id="tax_code" name="tax_code"
                                class="mt-2 w-full border gradient-border rounded-lg p-3 focus:ring-green-500 focus:border-green-500"
                                placeholder="Nhập mã số thuế">
                        </div>
                    </div>
                </div>

                <!-- Nút Đăng Ký -->
                <div class="text-center">
                    <button type="submit"
                        class="px-8 py-3 bg-gradient-to-r from-green-500 to-green-700 text-white font-semibold rounded-full shadow-lg hover:from-green-600 hover:to-green-800 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
                        Đăng Ký
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Constants for AppSheet API
        const appId = 'a184881b-ad55-4ed7-95b9-203f5a7820d6';
        const accessKey = 'V2-P3Zru-GjXwp-Yd4Q5-eC9Ij-cJiqK-wDl5H-dH9mD-PQWRA';
        const region = 'www';

        // Cloudinary config
        const config = {
            CLOUD_NAME: 'djtkoancg',
            UPLOAD_PRESET: 'Wowsqzdjfhs8',
            UPLOAD: {
                MAX_SIZE: 5 * 1024 * 1024, // 5MB
                ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp']
            }
        };

        // Initialize Choices.js instances
        let industryGroupChoices;
        let businessFieldChoices;

        // API request function using Fetch API instead of jQuery Ajax
        async function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;

            console.log("API Request URL:", apiUrl);
            console.log("API Request Data:", JSON.stringify({
                Action: action,
                Properties: {
                    Locale: 'vi-VN',
                    Timezone: 'Asia/Ho_Chi_Minh'
                },
                ...data
            }, null, 2));

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        Properties: {
                            Locale: 'vi-VN',
                            Timezone: 'Asia/Ho_Chi_Minh'
                        },
                        ...data
                    })
                });

                console.log("API Response Status:", response.status);
                console.log("API Response Status Text:", response.statusText);

                // Check if response is ok (status 200-299)
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error Response:", errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText || response.statusText}`);
                }

                // Parse JSON response or get empty object if no content
                let responseData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    console.log("Non-JSON response:", text);
                    responseData = { success: true }; // Assuming empty response is successful
                }

                console.log("API Success Response:", responseData);
                return responseData;
            } catch (error) {
                console.error("API Request Failed:", error);
                throw error;
            }
        }

        // Image to Base64 function
        async function getImageAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Format date correctly to dd/mm/yyyy
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);

            // Check if date is valid
            if (isNaN(date.getTime())) return '';

            // Get day, month, year and pad with leading zeros if needed
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // +1 because getMonth() returns 0-11
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Upload image to Cloudinary
        async function uploadImage(file) {
            // Validate file
            if (!file) {
                throw new Error('Không tìm thấy file');
            }

            if (file.size > config.UPLOAD.MAX_SIZE) {
                throw new Error(`Kích thước file không được vượt quá ${config.UPLOAD.MAX_SIZE / 1024 / 1024}MB`);
            }

            if (!config.UPLOAD.ALLOWED_TYPES.includes(file.type)) {
                throw new Error('Định dạng file không được hỗ trợ');
            }

            try {
                // Convert file to base64 if needed
                const base64Image = await getImageAsBase64(file);

                // Cloudinary configuration
                const CLOUDINARY_CLOUD_NAME = config.CLOUD_NAME || 'djtkoancg';
                const CLOUDINARY_UPLOAD_PRESET = config.UPLOAD_PRESET || 'Wowsqzdjfhs8';

                // Prepare form data
                const formData = new FormData();
                formData.append('file', base64Image);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                // Make request to Cloudinary
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                if (!response.ok) {
                    throw new Error('Upload failed: ' + response.statusText);
                }

                const data = await response.json();

                if (!data.secure_url) {
                    throw new Error('Invalid response from Cloudinary');
                }

                return {
                    success: true,
                    url: data.secure_url,
                    public_id: data.public_id,
                    metadata: {
                        name: data.original_filename,
                        size: data.bytes,
                        format: data.format,
                        width: data.width,
                        height: data.height
                    }
                };
            } catch (error) {
                console.error('Image upload failed:', error);
                throw new Error('Không thể tải ảnh lên: ' + error.message);
            }
        }

        // Show loading overlay
        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';

            const spinner = document.createElement('div');
            spinner.className = 'spinner';

            overlay.appendChild(spinner);
            document.body.appendChild(overlay);
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Disable form while submitting
        function disableForm() {
            const form = document.getElementById('memberForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = true;
            }
        }

        // Enable form after submitting
        function enableForm() {
            const form = document.getElementById('memberForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = false;
            }
        }

        // Show image preview
        function setupImagePreviews() {
            document.getElementById('image').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Hình ảnh">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('imagePreview').innerHTML = '';
                }
            });

            document.getElementById('company_logo').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('logoPreview');
                        preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Logo công ty">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('logoPreview').innerHTML = '';
                }
            });
        }

        // Show toast notification
        function showToast(message, success = true) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: success ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();
        }

        // Get selected radio value
        function getSelectedRadioValue(name) {
            const radios = document.getElementsByName(name);
            for (let i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    return radios[i].value;
                }
            }
            return null;
        }

        // Định nghĩa các mảng lựa chọn
        const nhomNganhNgheOptions = [
            "Khai thác và cung cấp nguyên liệu gỗ",
            "Chế biến gỗ",
            "Sản xuất đồ nội thất",
            "Sản xuất đồ thủ công mỹ nghệ từ gỗ",
            "Sản xuất vật liệu xây dựng từ gỗ",
            "Thiết kế và gia công sản phẩm gỗ",
            "Xuất nhập khẩu gỗ và sản phẩm từ gỗ",
            "Công nghệ và máy móc ngành gỗ",
            "Dịch vụ ngành gỗ"
        ];

        const nganhNgheKDOptions = [
            // Nhóm 1
            "Khai thác gỗ từ rừng tự nhiên",
            "Trồng rừng và khai thác gỗ từ rừng trồng",
            "Cung cấp nguyên liệu gỗ (gỗ tròn, gỗ xẻ, gỗ ghép, gỗ ván ép)",

            // Nhóm 2
            "Sản xuất ván ép, ván MDF, ván dăm, ván HDF",
            "Chế biến gỗ công nghiệp",
            "Xử lý gỗ (sấy khô, chống mối mọt, bảo quản)",
            "Tạo hình và gia công gỗ",

            // Nhóm 3
            "Sản xuất đồ nội thất gia đình (bàn, ghế, giường, tủ)",
            "Sản xuất nội thất văn phòng (bàn làm việc, tủ hồ sơ)",
            "Sản xuất nội thất trường học (bàn học, ghế học sinh)",
            "Sản xuất nội thất khách sạn, nhà hàng",

            // Nhóm 4
            "Chạm khắc gỗ",
            "Sản xuất đồ trang trí từ gỗ (tượng, tranh gỗ, lục bình)",
            "Sản xuất đồ lưu niệm bằng gỗ",

            // Nhóm 5
            "Sản xuất cửa gỗ, cửa sổ gỗ",
            "Sản xuất sàn gỗ",
            "Sản xuất gỗ dùng trong kết cấu xây dựng (dầm, cột, ván)",

            // Nhóm 6
            "Thiết kế mẫu mã sản phẩm gỗ",
            "Gia công CNC trên gỗ",
            "Sơn và hoàn thiện sản phẩm gỗ",

            // Nhóm 7
            "Xuất khẩu gỗ thô",
            "Xuất khẩu đồ nội thất gỗ",
            "Nhập khẩu gỗ nguyên liệu",

            // Nhóm 8
            "Sản xuất, kinh doanh máy móc chế biến gỗ (máy cưa, máy bào, máy xẻ gỗ)",
            "Cung cấp công nghệ xử lý gỗ (sấy, ép, ghép)",

            // Nhóm 9
            "Dịch vụ tư vấn thiết kế và sản xuất sản phẩm gỗ",
            "Dịch vụ bảo trì và sửa chữa máy móc ngành gỗ",
            "Dịch vụ logistics và vận chuyển gỗ"
        ];

        // Initialize Choices.js
        function initChoices() {
            // Thêm các tùy chọn vào select trước khi khởi tạo Choices
            const industryGroupSelect = document.getElementById('industry_group');
            const businessFieldSelect = document.getElementById('business_field');

            // Thêm các tùy chọn nhóm ngành nghề
            nhomNganhNgheOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                industryGroupSelect.appendChild(optionElement);
            });

            // Thêm các tùy chọn ngành nghề KD
            nganhNgheKDOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                businessFieldSelect.appendChild(optionElement);
            });

            // Industry Group Choices
            industryGroupChoices = new Choices('#industry_group', {
                removeItemButton: true,
                placeholder: true,
                placeholderValue: 'Chọn nhóm ngành nghề',
                noResultsText: 'Không tìm thấy kết quả phù hợp',
                itemSelectText: 'Nhấn để chọn',
                noChoicesText: 'Không còn lựa chọn nào',
                searchPlaceholderValue: 'Tìm kiếm...',
                renderChoiceLimit: -1,
                searchResultLimit: 100,
                shouldSort: false,
                classNames: {
                    containerOuter: 'choices',
                    containerInner: 'choices__inner',
                    input: 'choices__input',
                    inputCloned: 'choices__input--cloned',
                    list: 'choices__list',
                    listItems: 'choices__list--multiple',
                    listSingle: 'choices__list--single',
                    listDropdown: 'choices__list--dropdown',
                    item: 'choices__item',
                    itemSelectable: 'choices__item--selectable',
                    itemDisabled: 'choices__item--disabled',
                    itemChoice: 'choices__item--choice',
                    placeholder: 'choices__placeholder',
                    group: 'choices__group',
                    groupHeading: 'choices__heading',
                    button: 'choices__button',
                    activeState: 'is-active',
                    focusState: 'is-focused',
                    openState: 'is-open',
                    disabledState: 'is-disabled',
                    highlightedState: 'is-highlighted',
                    selectedState: 'is-selected',
                    flippedState: 'is-flipped',
                    loadingState: 'is-loading',
                    noResults: 'has-no-results',
                    noChoices: 'has-no-choices'
                }
            });

            // Business Field Choices
            businessFieldChoices = new Choices('#business_field', {
                removeItemButton: true,
                placeholder: true,
                placeholderValue: 'Chọn ngành nghề kinh doanh',
                noResultsText: 'Không tìm thấy kết quả phù hợp',
                itemSelectText: 'Nhấn để chọn',
                noChoicesText: 'Không còn lựa chọn nào',
                searchPlaceholderValue: 'Tìm kiếm...',
                renderChoiceLimit: -1,
                searchResultLimit: 100,
                shouldSort: false,
                classNames: {
                    containerOuter: 'choices',
                    containerInner: 'choices__inner',
                    input: 'choices__input',
                    inputCloned: 'choices__input--cloned',
                    list: 'choices__list',
                    listItems: 'choices__list--multiple',
                    listSingle: 'choices__list--single',
                    listDropdown: 'choices__list--dropdown',
                    item: 'choices__item',
                    itemSelectable: 'choices__item--selectable',
                    itemDisabled: 'choices__item--disabled',
                    itemChoice: 'choices__item--choice',
                    placeholder: 'choices__placeholder',
                    group: 'choices__group',
                    groupHeading: 'choices__heading',
                    button: 'choices__button',
                    activeState: 'is-active',
                    focusState: 'is-focused',
                    openState: 'is-open',
                    disabledState: 'is-disabled',
                    highlightedState: 'is-highlighted',
                    selectedState: 'is-selected',
                    flippedState: 'is-flipped',
                    loadingState: 'is-loading',
                    noResults: 'has-no-results',
                    noChoices: 'has-no-choices'
                }
            });
        }

        // Get values from Choices.js selections
        function getChoicesValues(choicesInstance) {
            if (choicesInstance && choicesInstance.getValue()) {
                return choicesInstance.getValue()
                    .map(item => item.value)
                    .join(', ');
            }
            return '';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            try {
                // Lấy giá trị trực tiếp từ các trường
                const fullname = document.getElementById('fullname').value.trim();
                const shortname = document.getElementById('shortname').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const birthday = document.getElementById('birthday').value;
                const hometown = document.getElementById('hometown').value.trim();
                const company_name = document.getElementById('company_name').value.trim();
                const position = document.getElementById('position').value.trim();
                const company_address = document.getElementById('company_address').value.trim();
                const tax_code = document.getElementById('tax_code').value.trim();
                const company_intro = document.getElementById('company_intro').value.trim();

                const ethnicity = document.getElementById('ethnicity').value.trim();
                const religion = document.getElementById('religion').value.trim();
                const education = document.getElementById('education').value;
                const company_founding_date = document.getElementById('company_founding_date').value;
                const referrer = document.getElementById('referrer').value.trim();

                // Lấy giá trị từ Choices.js
                const industry_group = getChoicesValues(industryGroupChoices);
                const business_field = getChoicesValues(businessFieldChoices);

                // Kiểm tra các trường bắt buộc
                if (!fullname || !email || !phone || !company_name || !company_address) {
                    let missingFields = [];
                    if (!fullname) missingFields.push("Họ và Tên");
                    if (!email) missingFields.push("Email");
                    if (!phone) missingFields.push("Số Điện Thoại");
                    if (!company_name) missingFields.push("Tên Công Ty");
                    if (!company_address) missingFields.push("Địa Chỉ Công Ty");

                    showToast(`Vui lòng nhập đầy đủ: ${missingFields.join(', ')}`, false);
                    return;
                }

                disableForm();
                showLoadingOverlay();

                // Get gender value (với giá trị mặc định là "Nam")
                const gender = getSelectedRadioValue('gender') || "Nam";

                // Format date correctly if exists
                // Replace these lines in the handleFormSubmit function
                let formattedBirthday = birthday ? formatDateToDDMMYYYY(birthday) : '';
                let formattedCompanyFoundingDate = company_founding_date ? formatDateToDDMMYYYY(company_founding_date) : '';

                // Upload images to Cloudinary
                let profileImageUrl = '';
                let companyLogoUrl = '';

                const profileImage = document.getElementById('image').files[0];
                if (profileImage) {
                    try {
                        const uploadResult = await uploadImage(profileImage);
                        if (uploadResult && uploadResult.success) {
                            profileImageUrl = uploadResult.url;
                        }
                    } catch (imgError) {
                        console.error("Error uploading profile image:", imgError);
                        // Continue without profile image
                    }
                }

                const companyLogo = document.getElementById('company_logo').files[0];
                if (companyLogo) {
                    try {
                        const uploadResult = await uploadImage(companyLogo);
                        if (uploadResult && uploadResult.success) {
                            companyLogoUrl = uploadResult.url;
                        }
                    } catch (logoError) {
                        console.error("Error uploading company logo:", logoError);
                        // Continue without company logo
                    }
                }

                // Thử với dữ liệu tối thiểu trước
                const minimalData = {
                    "Họ và tên": fullname,
                    "Email": email,
                    "Số điện thoại": phone,
                    "Giới tính": gender
                };

                try {
                    console.log("Sending minimal data to AppSheet...");
                    const response = await apiRequest('DSHV', 'Add', {
                        Rows: [minimalData]
                    });

                    console.log("Minimal data succeeded, sending full data...");

                    // If minimal data succeeds, prepare full data
                    const appSheetData = {
                        "Họ và Tên": fullname,
                        "Tên viết tắt": shortname || "",
                        "Giới tính": gender,
                        "Email": email,
                        "Image": profileImageUrl || "",
                        "SDT HV": phone,
                        "Sinh nhật HV": formattedBirthday || "",
                        "Nguyên Quán": hometown || "",
                        "Dân tộc": ethnicity || "",
                        "Tôn giáo": religion || "",
                        "Trình độ": education || "",
                        "Tên công ty": company_name || "",
                        "Chức vụ CTY": position || "",
                        "Địa chỉ CTY": company_address || "",
                        "MST": tax_code || "",
                        "Ngày thành lập CTY": formattedCompanyFoundingDate || "",
                        "Nhóm ngành nghề": industry_group || "",
                        "Ngành nghề KD": business_field || "",
                        "Người giới thiệu": referrer || "",
                        "Giới thiệu CTY": company_intro || "",
                        "Logo CT": companyLogoUrl || ""
                    };

                    console.log("Full data sending to AppSheet:", appSheetData);

                    // Send full data
                    await apiRequest('DSHV', 'Add', {
                        Rows: [appSheetData]
                    });

                    // Show success message
                    showToast("Đăng ký thành viên thành công!");

                    // Reset form
                    document.getElementById('memberForm').reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('logoPreview').innerHTML = '';

                    // Reset Choices.js selections
                    if (industryGroupChoices) industryGroupChoices.removeActiveItems();
                    if (businessFieldChoices) businessFieldChoices.removeActiveItems();
                } catch (apiError) {
                    console.error("API Error:", apiError);
                    throw new Error(`Lỗi gửi dữ liệu: ${apiError.message || 'Không có phản hồi từ server'}`);
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                showToast(`Đã xảy ra lỗi: ${error.message}`, false);
            } finally {
                enableForm();
                hideLoadingOverlay();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            setupImagePreviews();
            document.getElementById('memberForm').addEventListener('submit', handleFormSubmit);

            // Set male gender as default
            document.getElementById('male').checked = true;

            // Initialize Choices.js
            initChoices();
        });
    </script>
</body>

</html>
